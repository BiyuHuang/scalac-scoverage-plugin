<table class="classes"><tbody><tr>
      <td class="barContainerLeft"><a href="#">reaktor/scct/report/<span class="header">SourceFileHtmlReporter.scala</span></a></td>
      <td class="barContainerRight"><div class="percentages">
      <div class="bar">
        <div class="percentage">20 %</div>
        <div class="greenBar" style="width:40px;">&nbsp;</div>
      </div>
    </div></td>
    </tr><tr>
      <td class="barContainerLeft"><a href="src-_Users_mtkopone_projects_scct_scct_src_main_scala_reaktor_scct_report_SourceFileHtmlReporter.scala.html#Class_reaktor_scct_report_SourceFileHtmlReporter"><img src="class.png"></img>SourceFileHtmlReporter</a></td>
      <td class="barContainerRight"><div class="percentages">
      <div class="bar">
        <div class="percentage">20 %</div>
        <div class="greenBar" style="width:40px;">&nbsp;</div>
      </div>
    </div></td>
    </tr><tr>
      <td class="barContainerLeft"><a href="src-_Users_mtkopone_projects_scct_scct_src_main_scala_reaktor_scct_report_SourceFileHtmlReporter.scala.html#Object_reaktor_scct_report_SourceFileHtmlReporter"><img src="object.png"></img>SourceFileHtmlReporter</a></td>
      <td class="barContainerRight"><div class="percentages">
      <div class="bar">
        <div class="percentage">0 %</div>
        <div class="greenBar" style="width:0px;">&nbsp;</div>
      </div>
    </div></td>
    </tr></tbody></table><table class="source"><tbody><tr >
            <td class="black">1</td>
            <td>package reaktor.scct.report
</td>
          </tr><tr >
            <td class="black">2</td>
            <td>
</td>
          </tr><tr >
            <td class="black">3</td>
            <td>import xml.{Unparsed, NodeSeq, Text}
</td>
          </tr><tr >
            <td class="black">4</td>
            <td>import reaktor.scct.{Env, ClassTypes, Name, CoveredBlock}
</td>
          </tr><tr >
            <td class="black">5</td>
            <td>
</td>
          </tr><tr id="Object_reaktor_scct_report_SourceFileHtmlReporter">
            <td class="black">6</td>
            <td>object SourceFileHtmlReporter {
</td>
          </tr><tr >
            <td class="black">7</td>
            <td>  def report(sourceFile: String, data: CoverageData, env: Env) =
</td>
          </tr><tr >
            <td class="red">8</td>
            <td>    <span class="non">new SourceFileHtmlReporter(sourceFile, data, new SourceLoader(env), env).report
</span></td>
          </tr><tr >
            <td class="black">9</td>
            <td>}
</td>
          </tr><tr >
            <td class="black">10</td>
            <td>
</td>
          </tr><tr id="Class_reaktor_scct_report_SourceFileHtmlReporter">
            <td class="green">11</td>
            <td>class SourceFileHtmlReporter(sourceFile: String, data: CoverageData, sourceLoader: SourceLoader, env: Env) {
</td>
          </tr><tr >
            <td class="black">12</td>
            <td>  import HtmlReporter._
</td>
          </tr><tr >
            <td class="black">13</td>
            <td>
</td>
          </tr><tr >
            <td class="green">14</td>
            <td>  val sourcePath = env.sourceDir.getAbsolutePath
</td>
          </tr><tr >
            <td class="black">15</td>
            <td>
</td>
          </tr><tr >
            <td class="black">16</td>
            <td>  def report = {
</td>
          </tr><tr >
            <td class="red">17</td>
            <td>    <span class="non">sourceFileTableHeader ++ sourceFileTableContent
</span></td>
          </tr><tr >
            <td class="black">18</td>
            <td>  }
</td>
          </tr><tr >
            <td class="black">19</td>
            <td>
</td>
          </tr><tr >
            <td class="black">20</td>
            <td>  def sourceFileTableHeader = {
</td>
          </tr><tr >
            <td class="red">21</td>
            <td>    val header = <span class="non">itemRow(sourceFileHeader(sourceFile), data.percentage, &quot;#&quot;)
</span></td>
          </tr><tr >
            <td class="red">22</td>
            <td>    val classRows = <span class="non">classItemRows(data)
</span></td>
          </tr><tr >
            <td class="red">23</td>
            <td>    &lt;<span class="non">table class=&quot;classes&quot;&gt;&lt;tbody&gt;{ header }{ classRows }&lt;/tbody&gt;&lt;/table&gt;
</span></td>
          </tr><tr >
            <td class="black">24</td>
            <td>  }
</td>
          </tr><tr >
            <td class="black">25</td>
            <td>
</td>
          </tr><tr >
            <td class="black">26</td>
            <td>  def sourceFileHeader(sourceFile: String) = {
</td>
          </tr><tr >
            <td class="red">27</td>
            <td>    val name = <span class="non">formatSourceFileName(sourceFile)
</span></td>
          </tr><tr >
            <td class="red">28</td>
            <td>    <span class="non">name.lastIndexOf('/') match {
</span></td>
          </tr><tr >
            <td class="red">29</td>
            <td>      case -1 =&gt; &lt;<span class="non">span class=&quot;header&quot;&gt;{ name }&lt;/span&gt;
</span></td>
          </tr><tr >
            <td class="red">30</td>
            <td>      case idx =&gt; <span class="non">Text(name.substring(0, idx+1)) ++ &lt;span class=&quot;header&quot;&gt;{ name.substring(idx+1) }&lt;/span&gt;
</span></td>
          </tr><tr >
            <td class="black">31</td>
            <td>    }
</td>
          </tr><tr >
            <td class="black">32</td>
            <td>  }
</td>
          </tr><tr >
            <td class="black">33</td>
            <td>  def formatSourceFileName(sourceFile: String) = {
</td>
          </tr><tr >
            <td class="red">34</td>
            <td>    def trimRoot(s: String) = <span class="non">s.indexOf(sourcePath) match {
</span></td>
          </tr><tr >
            <td class="red">35</td>
            <td>      case -1 =&gt; <span class="non">s
</span></td>
          </tr><tr >
            <td class="red">36</td>
            <td>      case idx =&gt; <span class="non">s.substring(sourcePath.length + idx)
</span></td>
          </tr><tr >
            <td class="black">37</td>
            <td>    }
</td>
          </tr><tr >
            <td class="red">38</td>
            <td>    <span class="non">Some(sourceFile).map(trimRoot).map(_.replaceAll(&quot;//&quot;, &quot;/&quot;)).map(s =&gt; if (s.startsWith(&quot;/&quot;)) s.substring(1) else s).get
</span></td>
          </tr><tr >
            <td class="black">39</td>
            <td>  }
</td>
          </tr><tr >
            <td class="black">40</td>
            <td>
</td>
          </tr><tr >
            <td class="black">41</td>
            <td>  def sourceFileTableContent =
</td>
          </tr><tr >
            <td class="red">42</td>
            <td>    &lt;<span class="non">table class=&quot;source&quot;&gt;&lt;tbody&gt;{ sourceLines(sourceFile, data) }&lt;/tbody&gt;&lt;/table&gt;
</span></td>
          </tr><tr >
            <td class="black">43</td>
            <td>
</td>
          </tr><tr >
            <td class="black">44</td>
            <td>  def sourceLines(sourceFile: String, data: CoverageData): NodeSeq = {
</td>
          </tr><tr >
            <td class="red">45</td>
            <td>    <span class="non">sourceLines(1, 0, sourceLoader.linesFor(sourceFile), data.blocks, Name(&quot;&quot;, ClassTypes.Root, &quot;&quot;, &quot;&quot;), NodeSeq.Empty)
</span></td>
          </tr><tr >
            <td class="black">46</td>
            <td>  }
</td>
          </tr><tr >
            <td class="black">47</td>
            <td>
</td>
          </tr><tr >
            <td class="black">48</td>
            <td>  def sourceLines(lineNum: Int, offset: Int, lines: List[String], blocks: List[CoveredBlock], currentName: Name, acc: NodeSeq): NodeSeq = {
</td>
          </tr><tr >
            <td class="red">49</td>
            <td>    <span class="non">lines match {
</span></td>
          </tr><tr >
            <td class="red">50</td>
            <td>      case Nil =&gt; <span class="non">acc
</span></td>
          </tr><tr >
            <td class="black">51</td>
            <td>      case line :: tail =&gt; {
</td>
          </tr><tr >
            <td class="red">52</td>
            <td>        val maxOffset = <span class="non">offset + line.length // 2.7.7 doesn't count newLines, so no +1
</span></td>
          </tr><tr >
            <td class="red">53</td>
            <td>        val (<span class="non">currBlocks, nextBlocks) = blocks.partition(_.offset &lt; maxOffset)
</span></td>
          </tr><tr >
            <td class="red">54</td>
            <td>        val lineHtml = <span class="non">formatLine(line, offset, currBlocks.filter(!_.placeHolder))
</span></td>
          </tr><tr >
            <td class="red">55</td>
            <td>        val newName = <span class="non">currBlocks.firstOption.map(_.name).getOrElse(currentName)
</span></td>
          </tr><tr >
            <td class="red">56</td>
            <td>        val classId = if (<span class="non">currentName != newName) Some(Text(toHtmlId(newName))) else None
</span></td>
          </tr><tr >
            <td class="black">57</td>
            <td>        val rowHtml =
</td>
          </tr><tr >
            <td class="red">58</td>
            <td>          &lt;<span class="non">tr id={classId}&gt;
</span></td>
          </tr><tr >
            <td class="red">59</td>
            <td>            &lt;<span class="non">td class={chooseColor(currBlocks.filter(!_.placeHolder))}&gt;{lineNum}&lt;/td&gt;
</span></td>
          </tr><tr >
            <td class="red">60</td>
            <td>            &lt;<span class="non">td&gt;{ lineHtml }&lt;/td&gt;
</span></td>
          </tr><tr >
            <td class="black">61</td>
            <td>          &lt;/tr&gt;
</td>
          </tr><tr >
            <td class="red">62</td>
            <td>        <span class="non">sourceLines(lineNum + 1, maxOffset, tail, nextBlocks, newName, acc ++ rowHtml)
</span></td>
          </tr><tr >
            <td class="black">63</td>
            <td>      }
</td>
          </tr><tr >
            <td class="black">64</td>
            <td>    }
</td>
          </tr><tr >
            <td class="black">65</td>
            <td>  }
</td>
          </tr><tr >
            <td class="black">66</td>
            <td>
</td>
          </tr><tr >
            <td class="black">67</td>
            <td>  private def chooseColor(metadatas: List[CoveredBlock]) = {
</td>
          </tr><tr >
            <td class="red">68</td>
            <td>    <span class="non">metadatas.length match {
</span></td>
          </tr><tr >
            <td class="red">69</td>
            <td>      case 0 =&gt; <span class="non">&quot;black&quot;
</span></td>
          </tr><tr >
            <td class="black">70</td>
            <td>      case _ =&gt; {
</td>
          </tr><tr >
            <td class="red">71</td>
            <td>        val hits = <span class="non">metadatas.filter(_.count &gt; 0).size
</span></td>
          </tr><tr >
            <td class="red">72</td>
            <td>        if (<span class="non">hits == 0) &quot;red&quot; else if (hits == metadatas.length) &quot;green&quot; else &quot;yellow&quot;
</span></td>
          </tr><tr >
            <td class="black">73</td>
            <td>      }
</td>
          </tr><tr >
            <td class="black">74</td>
            <td>    }
</td>
          </tr><tr >
            <td class="black">75</td>
            <td>  }
</td>
          </tr><tr >
            <td class="black">76</td>
            <td>
</td>
          </tr><tr >
            <td class="black">77</td>
            <td>  def formatLine(line: String, offset: Int, blocks: List[CoveredBlock]): NodeSeq =
</td>
          </tr><tr >
            <td class="green">78</td>
            <td>    formatLine(List[Char](), line.toList, offset, true, blocks, NodeSeq.Empty)
</td>
          </tr><tr >
            <td class="black">79</td>
            <td>
</td>
          </tr><tr >
            <td class="black">80</td>
            <td>  private def formatLine(prevChars: List[Char], line: List[Char], offset: Int, isCovered: Boolean, blocks: List[CoveredBlock], acc: NodeSeq): NodeSeq = {
</td>
          </tr><tr >
            <td class="green">81</td>
            <td>    blocks match {
</td>
          </tr><tr >
            <td class="green">82</td>
            <td>      case Nil =&gt; acc ++ formatLinePart(prevChars ::: line, isCovered)
</td>
          </tr><tr >
            <td class="black">83</td>
            <td>      case block :: tail =&gt; {
</td>
          </tr><tr >
            <td class="green">84</td>
            <td>        val (currChars, nextChars) = line.splitAt(block.offset - offset)
</td>
          </tr><tr >
            <td class="green">85</td>
            <td>        if (isCovered == block.count &gt; 0) {
</td>
          </tr><tr >
            <td class="green">86</td>
            <td>          formatLine(prevChars ::: currChars, nextChars, block.offset, isCovered, tail, acc)
</td>
          </tr><tr >
            <td class="black">87</td>
            <td>        } else {
</td>
          </tr><tr >
            <td class="green">88</td>
            <td>          val part = formatLinePart(prevChars ::: currChars, isCovered)
</td>
          </tr><tr >
            <td class="green">89</td>
            <td>          formatLine(List[Char](), nextChars, block.offset, block.count &gt; 0, tail, acc ++ part)
</td>
          </tr><tr >
            <td class="black">90</td>
            <td>        }
</td>
          </tr><tr >
            <td class="black">91</td>
            <td>      }
</td>
          </tr><tr >
            <td class="black">92</td>
            <td>    }
</td>
          </tr><tr >
            <td class="black">93</td>
            <td>  }
</td>
          </tr><tr >
            <td class="black">94</td>
            <td>
</td>
          </tr><tr >
            <td class="black">95</td>
            <td>  private def formatLinePart(part: List[Char], isCovered: Boolean) = {
</td>
          </tr><tr >
            <td class="green">96</td>
            <td>    val nbsp = &quot;\u00A0\u00A0&quot;
</td>
          </tr><tr >
            <td class="green">97</td>
            <td>    val tabbed = part.mkString.replaceAll(&quot;\t&quot;, nbsp).replaceAll(&quot;  &quot;, nbsp)
</td>
          </tr><tr >
            <td class="green">98</td>
            <td>    if (isCovered) Text(tabbed) else &lt;span class=&quot;non&quot;&gt;{ tabbed }&lt;/span&gt;
</td>
          </tr><tr >
            <td class="black">99</td>
            <td>  }
</td>
          </tr><tr >
            <td class="black">100</td>
            <td>
</td>
          </tr><tr >
            <td class="black">101</td>
            <td>}</td>
          </tr></tbody></table>